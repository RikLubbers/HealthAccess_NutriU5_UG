# Weighted PMM MICE approach
## This code implements the weighted PMM (Predictive Mean Matching) MICE (Multiple Imputation by Chained Equations) approach.
## It is an alternative to the non-weighted PMM approach used in the Study1_analysis file.
## The weighted PMM approach is used here as a robustness check. 
## No major differences were found in terms of significance compared to the non-weighted PMM approach used in the Study1_analysis file.

```{r}
# Check if miceadds is installed, and install if not
if (!requireNamespace("miceadds", quietly = TRUE)) {
    install.packages("miceadds")
}

library(miceadds)

# empty imputation
imp0 <- mice::mice(DHS_children_sub,
    maxit = 0,
    meth = "pmm"
)

# redefine imputation methods
meth <- imp0$method
meth[meth == "pmm"] <- "weighted.pmm"

# redefine predictor matrix
pm <- imp0$predictorMatrix
pm[, 1:3] <- 0

# do imputation
DHS_children_sub_multimp_weighted <- mice::mice(DHS_children_sub,
    predictorMatrix = pm,
    method = meth,
    imputationWeights = DHS_children_sub$v005,
    m = 56,
    maxit = 5,
    set.seed = 123
)

# Model creation
## Stunting
MICE_model_stunt_weight <- with(
    DHS_children_sub_multimp_weighted,
    lm(HW5 ~ B4 + BORD + M19 + B11 + H11 + H22 + V481 + V729 + V505 + V191 + V212 + V445 + V714 + V113 + V136 + M5 + H7 + travel_time)
)

modelsummary(
    (pool(MICE_model_stunt_weight)),
    stars = TRUE,
    coef_rename = TRUE
)

## Wasting
MICE_model_wast_weight <- with(
    DHS_children_sub_multimp_weighted,
    lm(HW11 ~ B4 + BORD + M19 + B11 + H11 + H22 + V481 + V729 + V505 + V191 + V212 + V445 + V714 + V113 + V136 + M5 + H7 + travel_time, )
)

modelsummary(
    (pool(MICE_model_wast_weight)),
    stars = TRUE,
    coef_rename = TRUE
)

## Underweight
MICE_model_underweight_weight <-
    with(
        DHS_children_sub_multimp_weighted,
        lm(HW8 ~ B4 + BORD + M19 + B11 + H11 + H22 + V481 + V729 + V505 + V191 + V212 + V445 + V714 + V113 + V136 + M5 + H7 + travel_time, )
    )

modelsummary(
    (pool(MICE_model_underweight_weight)),
    stars = TRUE,
    coef_rename = TRUE
)

# Comparison of Weighted MICE Models
MICEmodels_weight <-
    modelsummary(list(MICE_model_stunt_weight, MICE_model_wast_weight, MICE_model_underweight_weight),
        stars = TRUE,
        coef_rename = TRUE,
        col.names = c("", "Stunting", "Wasting", "Underweight"),
        coef_omit = "^(?!trav)",
        gof_omit = ".*",
        conf_level = 0.95,
        fmt = fmt_significant(3),
        statistic = "{p.value} [{conf.low}, {conf.high}]",
    )

print(MICEmodels_weight)
```

